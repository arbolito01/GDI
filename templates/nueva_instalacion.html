{% extends "base.html" %}

{% block title %}Nueva Instalación{% endblock %}

{% block content %}
<div class="main-content-card">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Añadir Nueva Instalación/Solicitud</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <ul class="flashes mb-4">
                {% for category, message in messages %}
                    <li class="alert alert-{{ category }}">{{ message }}</li>
                {% endfor %}
            </ul>
        {% endif %}
    {% endwith %}

    <form action="{{ url_for('nueva_instalacion') }}" method="POST" enctype="multipart/form-data" class="space-y-4">
        <h2 class="form-section-title">Información de la Instalación</h2>
        <div class="form-group">
            <label for="nombre" class="form-label">Nombre de la Instalación</label>
            <select id="nombre" name="nombre" class="form-select" required>
                <option value="">Selecciona un tipo de instalación</option>
                {% for tipo in tipos_instalacion %}
                    <option value="{{ tipo }}">{{ tipo }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
    <label for="zona">Zona de Instalación</label>
    <select id="zona" name="zona" required>
        <option value="">Seleccione una zona</option>
        {% for zona in zonas %}
            <option value="{{ zona.id_zona }}">{{ zona.nombre }}</option>
        {% endfor %}
    </select>
</div>
        <div class="form-group">
            <label for="estado" class="form-label">Estado</label>
            <input type="hidden" name="estado" value="Pendiente">
            <p class="form-input bg-gray-200 text-gray-600">Pendiente</p>
        </div>
        <div class="form-group">
            <label for="imagen" class="form-label">Imagen de Referencia</label>
            <input type="file" id="imagen" name="imagen" class="form-file">
        </div>

        <h2 class="form-section-title mt-6">Detalles del Cliente</h2>
        
        <div class="form-group">
            <label for="cliente_existente" class="form-label">Seleccionar Cliente Existente</label>
            <select id="cliente_existente" class="form-select">
                <option value="">Selecciona un cliente</option>
                {% for cliente in clientes %}
                    <option value="{{ cliente.nombre }}" data-telefono="{{ cliente.telefono }}" data-referencia="{{ cliente.direccion }}">{{ cliente.nombre }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label for="dni" class="form-label">DNI</label>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="dni" class="form-input" placeholder="Ingresa el DNI...">
                <button type="button" id="search_dni_button" class="btn btn-primary">Buscar</button>
            </div>
        </div>

        <div class="form-group">
            <label for="nombre_cliente" class="form-label">Nombre del Cliente</label>
            <input type="text" id="nombre_cliente" name="nombre_cliente" class="form-input" required>
        </div>
        <div class="form-group">
            <label for="telefono_cliente" class="form-label">Teléfono del Cliente</label>
            <input type="tel" id="telefono_cliente" name="telefono_cliente" class="form-input" required>
        </div>
        <div class="form-group">
            <label for="telefono_referencia" class="form-label">Teléfono de Referencia (opcional)</label>
            <input type="tel" id="telefono_referencia" name="telefono_referencia" class="form-input">
        </div>
        
        <div class="form-group">
            <label for="referencia" class="form-label">Referencia del Domicilio</label>
            <input type="text" id="referencia" name="referencia" class="form-input" required>
        </div>

        <h2 class="form-section-title mt-6">Asignación de Tarea</h2>
        <div class="form-group">
            <label for="tecnico_asignado" class="form-label">Técnico Asignado</label>
            <select id="tecnico_asignado" name="tecnico_asignado" class="form-select" required>
                <option value="">Selecciona un técnico</option>
                {% for tecnico in tecnicos %}
                    <option value="{{ tecnico.id_usuario }}">{{ tecnico.nombre }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group grid grid-cols-1 md:grid-cols-2 gap-4">
    <div class="form-group">
        <label for="fecha_solicitada" class="form-label">Fecha Solicitada</label>
        <input type="date" id="fecha_solicitada" name="fecha_solicitada" class="form-input" required>
    </div>
    <div class="form-group">
        <label for="hora_solicitada" class="form-label">Hora Solicitada</label>
        <input type="time" id="hora_solicitada" name="hora_solicitada" class="form-input" required>
    </div>
</div>

        <h2 class="form-section-title mt-6">Ubicación GPS</h2>
        <button type="button" id="get-location-btn" class="btn-secondary w-full mb-4">Usar mi ubicación actual</button>
        <div id="map" class="h-64 w-full border border-gray-300 rounded-md mb-4"></div>
        <div class="form-group">
            <label for="latitud" class="form-label">Latitud</label>
            <input type="text" id="latitud" name="latitud" class="form-input" placeholder="Ej: -12.046374" required readonly>
        </div>
        <div class="form-group">
            <label for="longitud" class="form-label">Longitud</label>
            <input type="text" id="longitud" name="longitud" class="form-input" placeholder="Ej: -77.042793" required readonly>
        </div>

        <input type="hidden" id="codigo_cliente" name="codigo_cliente">
        <input type="hidden" id="pppoe_password" name="pppoe_password">

        <button type="submit" class="btn-primary w-full mt-6">
            Añadir Instalación
        </button>
    </form>
</div>

<script>
    const tipoInstalacionSelect = document.getElementById('nombre');
    const descripcionTextarea = document.getElementById('descripcion');
    const searchDniButton = document.getElementById('search_dni_button');
    const dniInput = document.getElementById('dni');
    const nombreClienteInput = document.getElementById('nombre_cliente');
    const telefonoClienteInput = document.getElementById('telefono_cliente');
    const referenciaInput = document.getElementById('referencia');
    
    // Diccionario de descripciones predefinidas
    const descripciones = {
        "Instalación Residencial": "Instalación de servicio de internet y TV para cliente residencial.",
        "Instalación Corporativa": "Instalación de servicio dedicado de internet para cliente corporativo.",
        "Reparación de Cable": "Reparación de rotura de cable en la red troncal.",
        "Mantenimiento de Nodo": "Mantenimiento preventivo en nodo de fibra óptica.",
        "Reconexión de Servicio": "Reconexión de servicio de internet a cliente previamente suspendido.",
        "Traslado de Servicio": "Traslado de equipo y servicio a nueva dirección del cliente.",
    };

    // Lógica para autocompletar descripción
    tipoInstalacionSelect.addEventListener('change', function() {
        const valorSeleccionado = this.value;
        if (descripciones[valorSeleccionado]) {
            descripcionTextarea.value = descripciones[valorSeleccionado];
        } else {
            descripcionTextarea.value = '';
        }
    });

    const clienteExistenteSelect = document.getElementById('cliente_existente');
    clienteExistenteSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.value) {
            nombreClienteInput.value = selectedOption.value;
            telefonoClienteInput.value = selectedOption.getAttribute('data-telefono');
            referenciaInput.value = selectedOption.getAttribute('data-referencia');
            // Limpia el DNI cuando se selecciona un cliente existente
            dniInput.value = '';
        } else {
            nombreClienteInput.value = '';
            telefonoClienteInput.value = '';
            referenciaInput.value = '';
        }
    });

    // Lógica para buscar DNI y autocompletar nombre
    searchDniButton.addEventListener('click', function() {
        const dni = dniInput.value;
        if (dni) {
            fetch(`/api/reniec_search?dni=${dni}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        nombreClienteInput.value = data.nombre;
                        // Llama a la función de autogeneración después de la búsqueda
                        generarDatosCliente(data.nombre);
                    } else {
                        alert(data.message);
                    }
                })
                .catch(error => {
                    console.error('Error al buscar DNI:', error);
                    alert('Error al conectar con la API de RENIEC.');
                });
        } else {
            alert('Por favor, ingrese un DNI.');
        }
    });

    // Lógica para autogenerar código de cliente y clave PPPoE
    nombreClienteInput.addEventListener('input', function() {
        const nombre = this.value;
        if (nombre) {
            generarDatosCliente(nombre);
        }
    });

    function generarDatosCliente(nombre) {
        // Lógica de autogeneración (simulada)
        const numero = Math.floor(Math.random() * 1000) + 5000;
        
        // Se elimina el .split() para usar el nombre completo
        const nombreCompleto = nombre.toUpperCase().replace(/\s/g, '-');
        const codigo = `${numero}-${nombreCompleto}`;
        
        const pppoe = Math.random().toString(36).substring(2, 8);
        
        document.getElementById('codigo_cliente').value = codigo;
        document.getElementById('pppoe_password').value = pppoe;
        
        // Muestra los valores generados en la interfaz de usuario
        // document.getElementById('codigo_cliente_display').innerText = codigo;
        // document.getElementById('pppoe_password_display').innerText = pppoe;
    }

    // Código de Google Maps y geolocalización...
    let map, marker;
    const latInput = document.getElementById('latitud');
    const lngInput = document.getElementById('longitud');
    const getLocationBtn = document.getElementById('get-location-btn');

    function initMap() {
        const defaultLocation = { lat: -12.046374, lng: -77.042793 }; // Lima, Perú
        map = new google.maps.Map(document.getElementById("map"), {
            zoom: 12,
            center: defaultLocation,
        });

        marker = new google.maps.Marker({
            position: defaultLocation,
            map: map,
            draggable: true,
        });

        latInput.value = defaultLocation.lat;
        lngInput.value = defaultLocation.lng;

        marker.addListener("dragend", (event) => {
            const newLat = event.latLng.lat();
            const newLng = event.latLng.lng();
            latInput.value = newLat.toFixed(6);
            lngInput.value = newLng.toFixed(6);
        });

        getLocationBtn.addEventListener('click', () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };
                        map.setCenter(pos);
                        marker.setPosition(pos);
                        latInput.value = pos.lat.toFixed(6);
                        lngInput.value = pos.lng.toFixed(6);
                    },
                    () => {
                        handleLocationError(true, map.getCenter());
                    }
                );
            } else {
                handleLocationError(false, map.getCenter());
            }
        });
    }

    function handleLocationError(browserHasGeolocation, pos) {
        alert(
            browserHasGeolocation
                ? "Error: El servicio de geolocalización falló o no se concedieron los permisos."
                : "Error: Tu navegador no soporta geolocalización."
        );
    }
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key={{ maps_api_key }}&callback=initMap"></script>
{% endblock %}