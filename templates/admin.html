{% extends "base.html" %}

{% block title %}Panel de Administrador{% endblock %}

{% block content %}
<div class="main-content-card">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Panel de Administrador</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <ul class="flashes mb-4">
                {% for category, message in messages %}
                    <li class="alert alert-{{ category }}">{{ message }}</li>
                {% endfor %}
            </ul>
        {% endif %}
    {% endwith %}

<h2 class="form-section-title mt-8 mb-4">Gestión de Clientes</h2>
<div class="overflow-x-auto">
    <table class="min-w-full bg-white rounded-lg shadow-md mt-4">
        <thead>
            <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                <th class="py-3 px-6 text-left">ID</th>
                <th class="py-3 px-6 text-left">Nombre</th>
                <th class="py-3 px-6 text-left">Teléfono</th>
                <th class="py-3 px-6 text-left">Estado de Pago</th>
                <th class="py-3 px-6 text-center">Acciones</th>
            </tr>
        </thead>
        <tbody class="text-gray-600 text-sm font-light">
            {% for cliente in clientes %}
            <tr class="border-b border-gray-200 hover:bg-gray-100">
                <td class="py-3 px-6 text-left whitespace-nowrap">{{ cliente.id_cliente }}</td>
                <td class="py-3 px-6 text-left">{{ cliente.nombre }}</td>
                <td class="py-3 px-6 text-left">{{ cliente.telefono_cliente }}</td>
                <td class="py-3 px-6 text-left">
                    <span class="py-1 px-3 rounded-full text-xs font-semibold
                        {% if cliente.estado_pago == 'Al día' %}bg-green-200 text-green-600{% elif cliente.estado_pago == 'Cortado' %}bg-red-200 text-red-600{% else %}bg-yellow-200 text-yellow-600{% endif %}">
                        {{ cliente.estado_pago or 'N/A' }}
                    </span>
                </td>
                <td class="py-3 px-6 text-center whitespace-nowrap">
                    {% if cliente.estado_pago == 'Cortado' %}
                        <form action="{{ url_for('reconectar_cliente', id_cliente=cliente.id_cliente) }}" method="POST" class="inline-block" onsubmit="return confirm('¿Estás seguro de que quieres reconectar a este cliente?');">
                            <button type="submit" class="text-green-500 hover:text-green-700 mx-1">Reconectar</button>
                        </form>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>


<h2 class="form-section-title mt-8 mb-4">Solicitudes de OLT Pendientes</h2>
<div class="overflow-x-auto">
    <table class="min-w-full bg-white rounded-lg shadow-md mt-4">
        <thead>
            <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                <th class="py-3 px-6 text-left">ID</th>
                <th class="py-3 px-6 text-left">Tipo</th>
                <th class="py-3 px-6 text-left">ONU S/N</th>
                <th class="py-3 px-6 text-left">Estado</th>
                <th class="py-3 px-6 text-center">Acciones</th>
            </tr>
        </thead>
        <tbody class="text-gray-600 text-sm font-light">
            {% for solicitud in solicitudes_olt %}
            <tr class="border-b border-gray-200 hover:bg-gray-100">
                <td class="py-3 px-6 text-left">{{ solicitud.id_solicitud }}</td>
                <td class="py-3 px-6 text-left">{{ solicitud.tipo_solicitud }}</td>
                <td class="py-3 px-6 text-left">{{ solicitud.onu_sn }}</td>
                <td class="py-3 px-6 text-left">
                    <span class="py-1 px-3 rounded-full text-xs font-semibold
                        {% if solicitud.estado == 'Pendiente' %}bg-yellow-200 text-yellow-600{% elif solicitud.estado == 'Aprobada' %}bg-green-200 text-green-600{% else %}bg-red-200 text-red-600{% endif %}">
                        {{ solicitud.estado }}
                    </span>
                </td>
                <td class="py-3 px-6 text-center whitespace-nowrap">
                    {% if solicitud.estado == 'Pendiente' %}
                    <form action="{{ url_for('aprobar_solicitud', id_solicitud=solicitud.id_solicitud) }}" method="POST" class="inline-block" onsubmit="return confirm('¿Aprobar esta solicitud?');">
                        <button type="submit" class="text-green-500 hover:text-green-700 mx-1">Aprobar</button>
                    </form>
                    <form action="{{ url_for('rechazar_solicitud', id_solicitud=solicitud.id_solicitud) }}" method="POST" class="inline-block" onsubmit="return confirm('¿Rechazar esta solicitud?');">
                        <button type="submit" class="text-red-500 hover:text-red-700 mx-1">Rechazar</button>
                    </form>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>


    <h2 class="form-section-title mt-8 mb-4">Gestión de Solicitudes/Instalaciones</h2>
    <a href="{{ url_for('nueva_instalacion') }}" class="btn-primary mb-6">
        Añadir Nueva Instalación
    </a>
    <a href="{{ url_for('reparacion_migracion') }}" class="btn-primary mb-6">
        Reparación/Migración
    </a>
    <a href="{{ url_for('importar_clientes') }}" class="btn-primary mb-6">
        Importar Clientes
    </a>
    
    <div class="filter-controls mt-6 mb-4">
        <label for="fecha_inicio">Fecha de inicio:</label>
        <input type="date" id="fecha_inicio">
        <label for="fecha_fin">Fecha de fin:</label>
        <input type="date" id="fecha_fin">
        <button onclick="filtrarPorFecha()">Filtrar</button>
    </div>

    <div class="overflow-x-auto mb-10">
        <table id="tabla-instalaciones" class="min-w-full bg-white rounded-lg shadow-md mt-4">
            <thead>
                <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                    <th class="py-3 px-6 text-left">ID</th>
                    <th class="py-3 px-6 text-left">Nombre</th>
                    <th class="py-3 px-6 text-left">Cliente</th>
                    <th class="py-3 px-6 text-left">Estado</th>
                    <th class="py-3 px-6 text-left">Técnico Asignado</th>
                    <th class="py-3 px-6 text-left">Fecha de Solicitud</th>
                    <th class="py-3 px-6 text-center">Acciones</th>
                </tr>
            </thead>
            <tbody class="text-gray-600 text-sm font-light">
                {% for instalacion in instalaciones %}
                <tr class="border-b border-gray-200 hover:bg-gray-100">
                    <td class="py-3 px-6 text-left whitespace-nowrap">{{ instalacion.id_instalacion }}</td>
                    <td class="py-3 px-6 text-left">{{ instalacion.nombre }}</td>
                    <td class="py-3 px-6 text-left">{{ instalacion.nombre_cliente }}</td>
                    <td class="py-3 px-6 text-left">
                        <span class="py-1 px-3 rounded-full text-xs font-semibold
                            {% if instalacion.estado_tarea == 'Completada' %}bg-green-200 text-green-600{% elif instalacion.estado_tarea == 'Pendiente' %}bg-yellow-200 text-yellow-600{% else %}bg-blue-200 text-blue-600{% endif %}">
                            {{ instalacion.estado_tarea or 'No Asignado' }}
                        </span>
                    </td>
                    <td class="py-3 px-6 text-left">
                        {{ instalacion.tecnico_asignado or 'No asignado' }}
                    </td>
                    <td class="py-3 px-6 text-left">
                        {{ instalacion.fecha_asignacion.strftime('%d/%m/%Y') if instalacion.fecha_asignacion else 'N/A' }}
                    </td>
                    <td class="py-3 px-6 text-center whitespace-nowrap">
                        {% if instalacion.estado_tarea == 'Completada' %}
                            <a href="{{ url_for('detalle_instalacion', id=instalacion.id_instalacion) }}" class="text-blue-500 hover:text-blue-700 mx-1">Detalles</a>
                        {% else %}
                            <form action="{{ url_for('eliminar_instalacion', id=instalacion.id_instalacion) }}" method="POST" class="inline-block" onsubmit="return confirm('¿Estás seguro de que quieres eliminar esta instalación y todas sus reservas y tareas asociadas?');">
                                <button type="submit" class="text-red-500 hover:text-red-700 mx-1">Eliminar</button>
                            </form>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="grid grid-cols-1 gap-6 mt-8">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-white rounded-lg shadow-md p-4">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Tareas por Estado</h3>
            <canvas id="tareasPorEstadoChart" style="max-height: 250px;"></canvas>
        </div>
        <div class="bg-white rounded-lg shadow-md p-4">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Tareas por Tipo</h3>
            <canvas id="tareasPorTipoChart" style="max-height: 250px;"></canvas>
        </div>
    </div>
    <div class="bg-white rounded-lg shadow-md p-4">
        <h3 class="text-xl font-semibold text-gray-800 mb-4">Top Técnicos (Tareas Completadas)</h3>
        <canvas id="topTecnicosChart" style="max-height: 250px;"></canvas>
    </div>
</div>
    
    <h2 class="form-section-title mt-8 mb-4">Gestión de Usuarios</h2>
    <div class="overflow-x-auto">
        <table class="min-w-full bg-white rounded-lg shadow-md mt-4">
            <thead>
                <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                    <th class="py-3 px-6 text-left">ID</th>
                    <th class="py-3 px-6 text-left">Nombre</th>
                    <th class="py-3 px-6 text-left">Email</th>
                    <th class="py-3 px-6 text-left">Rol</th>
                    <th class="py-3 px-6 text-center">Acciones</th>
                </tr>
            </thead>
            <tbody class="text-gray-600 text-sm font-light">
                {% for usuario in usuarios %}
                <tr class="border-b border-gray-200 hover:bg-gray-100">
                    <td class="py-3 px-6 text-left whitespace-nowrap">{{ usuario.id_usuario }}</td>
                    <td class="py-3 px-6 text-left">{{ usuario.nombre }}</td>
                    <td class="py-3 px-6 text-left">{{ usuario.email }}</td>
                    <td class="py-3 px-6 text-left">
                        <span class="py-1 px-3 rounded-full text-xs font-semibold
                            {% if usuario.es_admin %}bg-red-200 text-red-600{% else %}bg-green-200 text-green-600{% endif %}">
                            {% if usuario.es_admin %}Admin{% else %}Instalador{% endif %}
                        </span>
                    </td>
                    <td class="py-3 px-6 text-center whitespace-nowrap">
                        <a href="{{ url_for('editar_usuario', id=usuario.id_usuario) }}" class="text-blue-500 hover:text-blue-700 mx-1">Editar</a>
                        <form action="{{ url_for('eliminar_usuario', id=usuario.id_usuario) }}" method="POST" class="inline-block" onsubmit="return confirm('¿Estás seguro de que quieres eliminar a este usuario?');">
                            <button type="submit" class="text-red-500 hover:text-red-700 mx-1">Eliminar</button>
                        </form>
                        <form action="{{ url_for('toggle_admin', id=usuario.id_usuario) }}" method="POST" class="inline-block">
                            {% if usuario.es_admin %}
                                <button type="submit" class="text-yellow-500 hover:text-yellow-700 mx-1">Degradar</button>
                            {% else %}
                                <button type="submit" class="text-green-500 hover:text-green-700 mx-1">Promover</button>
                            {% endif %}
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        fetch('/api/admin_stats')
            .then(response => response.json())
            .then(data => {
                // Gráfico de Tareas por Estado
                const estadoLabels = data.tareas_por_estado.map(item => item.estado);
                const estadoData = data.tareas_por_estado.map(item => item.count);
                new Chart(
                    document.getElementById('tareasPorEstadoChart'),
                    {
                        type: 'doughnut',
                        data: {
                            labels: estadoLabels,
                            datasets: [{
                                label: 'Tareas por Estado',
                                data: estadoData,
                                backgroundColor: ['#FFC107', '#28A745', '#DC3545', '#4A90E2'],
                            }]
                        }
                    }
                );

                // Gráfico de Tareas Completadas por Técnico
                const tecnicoLabels = data.tareas_completadas_por_tecnico.map(item => item.nombre);
                const tecnicoData = data.tareas_completadas_por_tecnico.map(item => item.count);
                new Chart(
                    document.getElementById('topTecnicosChart'),
                    {
                        type: 'bar',
                        data: {
                            labels: tecnicoLabels,
                            datasets: [{
                                label: 'Tareas Completadas',
                                data: tecnicoData,
                                backgroundColor: '#4A90E2',
                            }]
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    }
                );

                // Gráfico de Tareas por Tipo
                const tipoLabels = data.tareas_por_tipo.map(item => item.tipo_tarea);
                const tipoData = data.tareas_por_tipo.map(item => item.count);
                new Chart(
                    document.getElementById('tareasPorTipoChart'),
                    {
                        type: 'pie',
                        data: {
                            labels: tipoLabels,
                            datasets: [{
                                label: 'Tareas por Tipo',
                                data: tipoData,
                                backgroundColor: ['#28a745', '#dc3545', '#ffc107', '#4a90e2'],
                            }]
                        }
                    }
                );
            });
    });
</script>
{% endblock %}