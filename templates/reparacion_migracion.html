{% extends "base.html" %}

{% block title %}Reparación/Migración de Cliente{% endblock %}

{% block content %}
<div class="header-nav">
    <a href="{{ url_for('admin') }}" class="btn btn-primary">Volver al Panel de Admin</a>
</div>

<div class="container">
    <h1>Asignar Tarea de Reparación/Migración</h1>
    
    <div class="main-content-card">
        <h2 class="form-section-title">Importar Clientes</h2>
        <form action="{{ url_for('importar_clientes') }}" method="post" enctype="multipart/form-data" class="space-y-4">
            <div class="form-group">
                <label for="file" class="form-label">Selecciona un archivo CSV (.csv)</label>
                <input type="file" id="file" name="file" class="form-file" accept=".csv" required>
            </div>
            <button type="submit" class="btn-primary w-full">Importar Archivo CSV</button>
        </form>
    </div>

    <form action="{{ url_for('reparacion_migracion') }}" method="POST" class="form-reserva mt-8">
        
        <h2 class="form-section-title">Datos del Cliente</h2>

        <div class="form-group">
            <label for="cliente_search">Buscar Cliente:</label>
            <input type="text" id="cliente_search" class="form-input" placeholder="Escribe el nombre del cliente...">
            <datalist id="clientes-list">
                {% for cliente in clientes %}
                    <option value="{{ cliente.username }}" data-service="{{ cliente.service }}" data-phone="{{ cliente.phone }}">
                {% endfor %}
            </datalist>
        </div>

        <div class="form-group">
            <label for="nombre_cliente">Nombre de Cliente (Seleccionado):</label>
            <input type="text" id="nombre_cliente" name="nombre_cliente" class="form-input" readonly required>
        </div>

        <div class="form-group">
            <label for="tipo_servicio">Tipo de Servicio:</label>
            <input type="text" id="tipo_servicio" name="tipo_servicio" readonly required>
        </div>
        <div class="form-group">
            <label for="telefono_cliente">Teléfono del Cliente:</label>
            <input type="tel" id="telefono_cliente" name="telefono_cliente" readonly required>
        </div>
        
        <h2 class="form-section-title">Detalles de la Tarea</h2>
        <div class="form-group">
            <label for="tipo_tarea">Tipo de Tarea:</label>
            <select id="tipo_tarea" name="tipo_tarea" class="form-select" required>
                <option value="Reparacion">Reparación</option>
                <option value="Migracion">Migración</option>
                <option value="Traslado">Traslado</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="id_usuario_asignado">Asignar a:</label>
            <select id="id_usuario_asignado" name="id_usuario_asignado" class="form-select" required>
                {% for usuario in usuarios_no_admin %}
                    <option value="{{ usuario.id_usuario }}">{{ usuario.nombre }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="form-group">
            <label for="descripcion">Descripción de la Tarea:</label>
            <textarea id="descripcion" name="descripcion" rows="4" required></textarea>
        </div>

        <button type="submit" class="btn btn-success">Asignar Tarea</button>
        <a href="{{ url_for('admin') }}" class="btn btn-danger">Cancelar</a>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('cliente_search');
        const nombreClienteInput = document.getElementById('nombre_cliente');
        const tipoServicioInput = document.getElementById('tipo_servicio');
        const telefonoClienteInput = document.getElementById('telefono_cliente');
        const datalist = document.getElementById('clientes-list');

        function updateClientInfo(selectedUsername) {
            const selectedOption = datalist.querySelector(`option[value="${selectedUsername}"]`);
            if (selectedOption) {
                nombreClienteInput.value = selectedUsername;
                tipoServicioInput.value = selectedOption.getAttribute('data-service') || '';
                telefonoClienteInput.value = selectedOption.getAttribute('data-phone') || '';
            } else {
                nombreClienteInput.value = '';
                tipoServicioInput.value = '';
                telefonoClienteInput.value = '';
            }
        }

        searchInput.addEventListener('input', function() {
            updateClientInfo(this.value);
        });
        
        // Cargar los clientes en el datalist al inicio
        // La lista de clientes ya viene precargada desde el backend, no se necesita una llamada fetch inicial
    });
</script>
{% endblock %}